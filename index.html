<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>&#9955; Timer</title>
  <!-- <link rel="icon" href="favicon.ico" type="image/x-icon" /> -->
  <!-- <link rel="icon" href="data:image/svg+xml;utf8,üòä" /> -->

  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.3.5/dist/alpine.min.js" defer></script>
  <!-- <link rel="stylesheet" href="styles.css" /> -->
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      /* display: flex; */
      /* flex-direction: column; */
      align-items: center;
      margin-top: 1rem;
    }

    .app {
      /* min-width: 300px;
      max-width: 700px; */
      border-radius: 2px;
      padding: 20px;
      font-size: 1.125rem;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.19),
        0 6px 6px rgba(0, 0, 0, 0.23);
    }

    h1 {
      font-size: 1.5rem;
    }

    .settings {
      margin-bottom: 16px;

      &>* {
        display: flex;
        margin-top: 8px;
        gap: 8px;

        input {
          flex: 1;
          padding: 0.4rem;
          padding-left: 0.5rem;
          min-width: 0;
        }

        button {
          padding: 0 10px;
          background: #3182ce;
          color: white;
          border: none;
          transition: all 0.3s;
        }

        button:hover {
          background: #2a4365;
          transition: all 0.3s;
        }
      }
    }

    .row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;

      list-style: none;
      padding: 0.5rem;
      border-radius: 2px;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);

      &:not(.header):hover {
        cursor: pointer;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16),
          0 3px 6px rgba(0, 0, 0, 0.23);
      }

      &.header {
        background-color: gainsboro;
      }
    }
  </style>
</head>

<body>
  <div x-data="timer()" x-init="init()" class="app">
    <form class="settings" @submit="addParticipant($event)">
      <div>
        <!-- <label>
            –°—Ç–∞—Ä—Ç
            <input
              type="time"
              x-model="start"
              required
              placeholder="–í—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞"
            /> </label
          ><label> -->
        –ò–Ω—Ç–µ—Ä–≤–∞–ª
        <input type="number" x-model="interval" required placeholder="–ù–∞—á–∞–ª—å–Ω–æ–µ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –≤ —Å" style="width: 5em" />
        </label>
      </div>
      <div class="participant_add">
        <input type="number" x-model="number" required placeholder="–ù–æ–º–µ—Ä" />
        <input type="text" x-model="name" placeholder="–£—á–∞—Å—Ç–Ω–∏–∫" />
        <button>–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </form>

    <div class="header row">
      <div>–£—á–∞—Å—Ç–Ω–∏–∫</div>
      <!-- <div>–ö—Ä—É–≥</div> -->
      <template x-for="l in laps">
        <div><span>—ç—Ç–∞–ø </span><span x-text="l"></span></div>
      </template>
    </div>

    <template x-for="p in participants" :key="p.id">
      <div @click="check(p.id)" class="row">
        <div>
          <b x-text="p.id"></b>
          <span x-text="p.name"></span>
        </div>
        <!-- <span x-text="p.laps.length"></span> -->
        <template x-for="lap in p.laps">
          <div :style="getColor(lap.position);">
            <div>–º–µ—Å—Ç–æ:<span x-text="lap.position"></span></div>
            <template x-for="delay in lap.delays">
              <div>
                <!-- <span>–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ: </span> --><span x-text="delay"></span>
              </div>
              <!-- <div><span>–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ: </span><span x-text="delay"></span></div> -->
            </template>
          </div>
        </template>
      </div>
    </template>
  </div>

  <script>
    function timer() {
      return {
        colors: Object.values({
          "Yellow 0": "#fcf9e8", "Yellow 5": "#f5e6ab", "Yellow 10": "#f2d675",
          "Yellow 20": "#f0c33c", "Yellow 30": "#dba617", "Yellow 40": "#bd8600",
          "Yellow 50": "#996800", "Yellow 60": "#755100", "Yellow 70": "#614200",
          "Yellow 80": "#4a3200", "Yellow 90": "#362400", "Yellow 100": "#211600"
        }).reverse().slice(5),
        tzOffset: new Date().getTimezoneOffset() * 60_000,
        settings: { interval: undefined },
        start: "11:00",
        interval: 15,
        number: NaN,
        name: "",
        participants: [], // participant: {id: number; title: string; laps: {time: number; position: number; delays: string[]}}[]
        participantsSorted: [],
        laps: [],

        init: function () {
          this.participants = this.participantsSorted = [
            "–ü–µ—Ä–≤—ã–π",
            "–í—Ç–æ—Ä–æ–π",
            "–¢—Ä–µ—Ç–∏–π",
            "",
            "",
            "",
            "",
            "",
            "",
            "",

          ].map((name, id) => ({
            id: id + 1,
            name,
            laps: [],
          }));
          // this.participants.push({
          //   id: 77,
          //   laps: [],
          // });
        },
        saveSettings: function () {
          console.log(this.start);
          debugger;
        },
        addParticipant(event) {
          event.preventDefault();
          if (this.number) {
            this.participants.push({
              id: this.number,
              name: this.name,
              laps: [],
            });
          }
          this.number = NaN;
          this.name = "";
        },
        check(id) {
          const participant = this.getById(id);
          participant.laps.push({ time: Date.now(), delays: [] });
          const lap = participant.laps.length;

          this.participantsSorted = [...this.participants]
            .filter((v) => v.laps[lap - 1])
            .sort((p1, p2) => this.dif(p1, p2, lap - 1));
          console.log(JSON.parse(JSON.stringify(this.participantsSorted)));

          this.updateParticipants(lap);
          console.log(JSON.parse(JSON.stringify(this.participants)));

          if (participant.laps.length > this.laps.length)
            this.laps.push(this.laps.length + 1);
        },
        updateParticipants(currentLap) {
          for (participant of this.participants) {
            const lap = participant.laps[currentLap - 1];
            if (lap) {
              lap.position = participant.laps[currentLap - 1]
                ? this.participantsSorted.findIndex(
                  (v) => v === participant
                ) + 1
                : undefined;

              lap.delays = this.participantsSorted
                // .slice(0, 3)
                .map((p) => [p, this.dif(participant, p, currentLap - 1)])
                .filter(([p, dif]) => dif > 0)
                .filter((v, i, arr) => i == 0 || i > arr.length - 3)
                .map(([p, dif]) => this.formatTime(p, dif));
            }
          }
        },
        getById(id) {
          return this.participants.find((v) => v.id === id);
        },
        getColor(position) {
          return `background-color: ${this.colors[position]}`
        },
        startOffset(participant) {
          console.log(participant.id, participant.id * this.interval);
          return participant.id * this.interval * 1000;
        },
        dif(p1, p2, lap) {
          if (!p1.laps[lap] || !p2.laps[lap]) return -1;
          const time1 = p1.laps[lap].time - this.startOffset(p1);
          const time2 = p2.laps[lap].time - this.startOffset(p2);
          return time1 - time2;
        },
        formatTime(participant, time) {
          // return new Date(time + this.tzOffset).toLocaleTimeString();
          const milliseconds = Math.floor(time / 10) % 100;
          const seconds = Math.floor(time / 1000) % 60;
          const minutes = Math.floor(time / 60_000);

          // return `+${addZero(minutes)}:${addZero(seconds)}.${milliseconds}`;
          return `(${participant.id})+${addZero(minutes)}:${addZero(seconds)}`;

          function addZero(number) {
            return number < 10 ? "0" + number : number;
          }
        },
      };
    }
  </script>
</body>

</html>